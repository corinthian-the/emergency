<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Near Miss Reporting Form — Safety Near Miss Report</title>
<style>
  :root{--blue:#0b61ff;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f5f7fb;margin:0;color:#111;padding:18px}
  .wrap{max-width:900px;margin:26px auto;padding:22px;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  header small{display:block;color:var(--muted);margin-bottom:8px}
  h1{color:var(--blue);margin:0 0 6px;font-size:22px}
  p.lead{margin:0 0 18px;color:#444}
  label{display:block;margin-top:12px;font-weight:600;font-size:14px}
  input[type=text],input[type=date],input[type=time],textarea,select{
    width:100%;padding:10px;margin-top:6px;border:1px solid #dfe6ef;border-radius:8px;font-size:14px;
  }
  textarea{min-height:90px;resize:vertical}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .checkbox-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  .actions{margin-top:18px;text-align:center}
  button{background:var(--blue);color:#fff;border:0;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
  .note{font-size:13px;color:var(--muted);margin-top:12px}
  #qrcode-wrapper{ text-align:center;margin-top:26px; }
  #qrcode-wrapper canvas{display:block;margin:12px auto}
  .qr-page{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#f7f7f7}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<main class="wrap" id="mainWrap">
  <header>
    <small>Form Number: DOC.F.3746 · Doc Owner: Teresia Kigera · Revision: 0 · Effective Date: 2024-07-16</small>
    <h1>Safety Near Miss Report</h1>
    <p class="lead">A near-miss is an unplanned event that did not result in injury, illness, or damage, but had the potential to do so. Use this form to report near misses so we can prevent future incidents. Submissions will be emailed to <strong>felixthuo22@gmail.com</strong> and saved to the designated Google Sheet.</p>
  </header>

  <!-- FORM -->
  <form id="nmForm"
        action="https://formsubmit.co/felixthuo22@gmail.com"
        method="POST"
        enctype="multipart/form-data"
        accept-charset="utf-8">

    <input type="hidden" name="_subject" value="New Near Miss Report">
    <input type="hidden" name="_captcha" value="false">
    <input type="hidden" name="_template" value="table">
    <input type="hidden" name="_next" value="">
    <input type="hidden" id="ts" name="Timestamp" value="">

    <div class="grid">
      <div>
        <label for="date">Date of Near Miss</label>
        <input id="date" name="Date" type="date" required>
      </div>
      <div>
        <label for="time">Time of Near Miss</label>
        <input id="time" name="Time" type="time" required>
      </div>
    </div>

    <label for="location">Location of Near Miss</label>
    <input id="location" name="Location" type="text" placeholder="e.g., Site name, Warehouse 2, Loading Bay" required>

    <label>Category</label>
    <div class="checkbox-grid" role="group" aria-label="Near miss categories">
      <label><input type="checkbox" name="Category_Checks" value="Fall from height"> Fall from height</label>
      <label><input type="checkbox" name="Category_Checks" value="Trip / fall on same level"> Trip / fall on same level</label>
      <label><input type="checkbox" name="Category_Checks" value="Fall from equipment"> Fall from equipment</label>
      <label><input type="checkbox" name="Category_Checks" value="Hazardous Manual Handling"> Hazardous Manual Handling</label>
      <label><input type="checkbox" name="Category_Checks" value="Electric Shock"> Electric Shock</label>
      <label><input type="checkbox" name="Category_Checks" value="Caught between/underneath"> Caught between/underneath</label>
      <label><input type="checkbox" name="Category_Checks" value="Hazardous Substance"> Hazardous Substance</label>
      <label><input type="checkbox" name="Category_Checks" value="Falling object"> Falling object</label>
      <label><input type="checkbox" name="Category_Checks" value="Other"> Other (tick and describe below)</label>
    </div>

    <label for="othercat">If Other, please describe</label>
    <input id="othercat" name="Category_Other" type="text" placeholder="Describe other category (optional)">

    <label for="describe">Describe how the Near Miss occurred</label>
    <textarea id="describe" name="Describe" required placeholder="Describe what happened (who, what, where, how)"></textarea>

    <label for="leadup">Describe what lead up to and caused the Near Miss</label>
    <textarea id="leadup" name="LeadUpCause" required placeholder="Describe sequence, contributing factors"></textarea>

    <label for="photos">Photo/s (optional)</label>
    <input id="photos" name="Photos" type="file" accept="image/*" multiple>

    <label for="safety">Safety suggestions</label>
    <textarea id="safety" name="SafetySuggestions" required placeholder="Suggestions for prevention"></textarea>

    <div class="grid">
      <div>
        <label for="signname">Name (optional)</label>
        <input id="signname" name="ReporterName" type="text" placeholder="Name (optional)">
      </div>
      <div>
        <label for="signature">Signature (optional)</label>
        <input id="signature" name="Signature" type="text" placeholder="Signature (typed)">
      </div>
    </div>

    <p class="small">(Copies of the completed Near Miss Report Form are to be sent to your supervisor and the Health & Safety Co-Ordinator.)</p>

    <div class="actions">
      <button type="submit" id="submitBtn">Submit Near Miss Report</button>
    </div>

    <div id="status" class="note" aria-live="polite"></div>
  </form>

  <!-- QR Section -->
  <div id="qrcode-wrapper">
    <h3 style="text-align:center;margin-top:22px">Scan to Open this Form</h3>
    <canvas></canvas>
    <div style="text-align:center;color:var(--muted);font-size:13px;margin-top:6px">Or copy the page URL</div>
  </div>
</main>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyYSGFWKknb2p77-PIczW2kv3oQBvZn12U_i9JGyTyt0DbTu2FnFCacmK0IXLbLBhE/exec";

(function(){
  const form = document.getElementById('nmForm');
  const status = document.getElementById('status');
  const submitBtn = document.getElementById('submitBtn');
  const ts = document.getElementById('ts');

  // Set timestamp
  ts.value = new Date().toISOString();

  // Generate QR code (canvas)
  const qrCanvas = document.querySelector('#qrcode-wrapper canvas');
  QRCode.toCanvas(qrCanvas, window.location.href, {width:250}, err => { if(err) console.error(err); });

  // Helper: collect multiple categories
  function collectCategories(formData){
    const cats = [];
    for(const pair of formData.entries()){
      if(pair[0]==='Category_Checks') cats.push(pair[1]);
    }
    return cats.join('; ');
  }

  // Form submit
  form.addEventListener('submit', function(e){
    e.preventDefault();
    submitBtn.disabled = true;
    status.textContent = "Saving to spreadsheet and sending email...";

    const fd = new FormData(form);

    const payload = {
      Timestamp: new Date().toISOString(),
      Date: fd.get('Date')||'',
      Time: fd.get('Time')||'',
      Location: fd.get('Location')||'',
      Category: collectCategories(fd)||fd.get('Category_Other')||'',
      Describe: fd.get('Describe')||'',
      LeadUpCause: fd.get('LeadUpCause')||'',
      SafetySuggestions: fd.get('SafetySuggestions')||'',
      ReporterName: fd.get('ReporterName')||'',
      Signature: fd.get('Signature')||''
    };

    // Send JSON to Google Script
    fetch(GOOGLE_SCRIPT_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    }).then(resp => resp.json ? resp.json().catch(()=>{}) : {})
      .catch(err => console.error('Google script error:',err))
      .finally(()=> setTimeout(()=>form.submit(),250));
  });
})();
</script>
</body>
</html>

